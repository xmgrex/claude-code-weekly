name: Weekly Claude Code Research

on:
  schedule:
    # 毎週月曜 00:00 UTC (日本時間 09:00)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      custom_topic:
        description: '特定のトピックを指定（空欄で通常実行）'
        required: false
        default: ''

jobs:
  research-and-write:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Run Claude Code research
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          OUTPUT_FILE="articles/${{ steps.date.outputs.date }}-claude-code-weekly.md"
          CUSTOM_TOPIC="${{ github.event.inputs.custom_topic }}"

          if [ -n "$CUSTOM_TOPIC" ]; then
            PROMPT="prompts/research.md の指示に従ってClaude Codeの最新情報をリサーチし、${OUTPUT_FILE} に記事を書いてください。追加トピック: ${CUSTOM_TOPIC}"
          else
            PROMPT="prompts/research.md の指示に従ってClaude Codeの最新情報をリサーチし、${OUTPUT_FILE} に記事を書いてください。"
          fi

          claude -p "$PROMPT" --allowedTools "WebSearch,WebFetch,Write,Read"

      - name: Check if article was created
        id: check
        run: |
          if [ -f "articles/${{ steps.date.outputs.date }}-claude-code-weekly.md" ]; then
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "created=false" >> $GITHUB_OUTPUT
          fi

      - name: Push to Notion
        if: steps.check.outputs.created == 'true'
        uses: tryfabric/markdown-to-notion@main
        with:
          file: articles/${{ steps.date.outputs.date }}-claude-code-weekly.md
          notion_token: ${{ secrets.NOTION_TOKEN }}
          notion_id: ${{ secrets.NOTION_PAGE_ID }}

      - name: Commit and push
        if: steps.check.outputs.created == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add articles/
          git commit -m "docs: add weekly Claude Code research (${{ steps.date.outputs.date }})" || exit 0
          git push
